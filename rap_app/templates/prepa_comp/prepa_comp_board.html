{% extends "base.html" %}
{% load static %}

{% block title %}Tableau de Bord PrepaComp{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h1 class="mb-4">Tableau de bord PrepaComp</h1>
  
  <!-- Onglets pour choisir la période -->
  <ul class="nav nav-tabs mb-4" id="periodeTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if onglet_actif == 'semaine' %}active{% endif %}" 
         href="{% url 'prepacomp:tableau_de_bord' %}?onglet=semaine">Semaine</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if onglet_actif == 'mois' %}active{% endif %}" 
         href="{% url 'prepacomp:tableau_de_bord' %}?onglet=mois">Mois</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if onglet_actif == 'annee' %}active{% endif %}" 
         href="{% url 'prepacomp:tableau_de_bord' %}?onglet=annee">Année</a>
    </li>
  </ul>
  
  <div class="row">
    <!-- Statistiques globales -->
    <div class="col-md-12 mb-4">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title">
            {% if onglet_actif == 'semaine' %}
              Statistiques de la semaine {{ periode_courante.numero_semaine }} ({{ periode_courante.date_debut|date:"d/m/Y" }} - {{ periode_courante.date_fin|date:"d/m/Y" }})
            {% elif onglet_actif == 'mois' %}
              Statistiques de {{ periode_courante.nom_mois }} {{ periode_courante.annee }}
            {% else %}
              Statistiques de l'année {{ annee_courante }}
            {% endif %}
          </h2>
          
          <div class="row">
            <div class="col-md-3">
              <div class="card bg-light mb-3">
                <div class="card-body text-center">
                  <h5 class="card-title">Entrées</h5>
                  {% if onglet_actif == 'semaine' %}
                    <p class="display-4">{{ periode_courante.nombre_entrees }}</p>
                    <p>Objectif: {{ periode_courante.objectif_annuel.objectif_hebdomadaire|floatformat:0 }}</p>
                  {% elif onglet_actif == 'mois' %}
                    <p class="display-4">{{ periode_courante.nombre_entrees }}</p>
                    <p>Objectif: {{ periode_courante.objectif_annuel.objectif_mensuel|floatformat:0 }}</p>
                  {% else %}
                    <p class="display-4">{{ nombre_entrees }}</p>
                    <p>Objectif: {{ objectif_annuel.objectif }}</p>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="card bg-light mb-3">
                <div class="card-body text-center">
                  <h5 class="card-title">Candidats</h5>
                  {% if onglet_actif == 'semaine' %}
                    <p class="display-4">{{ periode_courante.nombre_candidats }}</p>
                  {% elif onglet_actif == 'mois' %}
                    <p class="display-4">{{ periode_courante.nombre_candidats }}</p>
                  {% else %}
                    <p class="display-4">{{ nombre_candidats }}</p>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="card bg-light mb-3">
                <div class="card-body text-center">
                  <h5 class="card-title">Taux de transformation</h5>
                  {% if onglet_actif == 'semaine' %}
                    <p class="display-4">{{ periode_courante.taux_transformation|floatformat:1 }}%</p>
                  {% elif onglet_actif == 'mois' %}
                    <p class="display-4">{{ periode_courante.taux_transformation|floatformat:1 }}%</p>
                  {% else %}
                    <p class="display-4">{{ taux_transformation|floatformat:1 }}%</p>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="card bg-light mb-3">
                <div class="card-body text-center">
                  <h5 class="card-title">Atteinte objectif</h5>
                  {% if onglet_actif == 'semaine' %}
                    <p class="display-4">{{ periode_courante.pourcentage_objectif_hebdomadaire|floatformat:1 }}%</p>
                  {% elif onglet_actif == 'mois' %}
                    <p class="display-4">{{ periode_courante.pourcentage_objectif_mensuel|floatformat:1 }}%</p>
                  {% else %}
                    <p class="display-4">{{ pourcentage_objectif|floatformat:1 }}%</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Graphique d'évolution -->
    <div class="col-md-8 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">
            {% if onglet_actif == 'semaine' %}
              Évolution des entrées par semaine
            {% elif onglet_actif == 'mois' %}
              Évolution des entrées par mois
            {% else %}
              Évolution des entrées par année
            {% endif %}
          </h5>
          <canvas id="evolutionChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Répartition par département -->
    <div class="col-md-4 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Répartition par département</h5>
          <canvas id="deptsChart" width="200" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  {% if onglet_actif == 'annee' %}
  <!-- Graphique par mois pour l'année courante -->
  <div class="row">
    <div class="col-md-12 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Répartition par mois pour {{ annee_courante }}</h5>
          <canvas id="monthsChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- Tableau historique -->
  <div class="row">
    <div class="col-md-12 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">
            {% if onglet_actif == 'semaine' %}
              Historique des semaines
            {% elif onglet_actif == 'mois' %}
              Historique des mois
            {% else %}
              Historique des années
            {% endif %}
          </h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  {% if onglet_actif == 'semaine' %}
                    <th>Semaine</th>
                    <th>Période</th>
                  {% elif onglet_actif == 'mois' %}
                    <th>Mois</th>
                    <th>Année</th>
                  {% else %}
                    <th>Année</th>
                  {% endif %}
                  <th>Entrées</th>
                  <th>Candidats</th>
                  <th>Taux</th>
                  <th>Objectif</th>
                  <th>% Objectif</th>
                  <th>Détails</th>
                </tr>
              </thead>
              <tbody>
                {% if onglet_actif == 'semaine' %}
                  {% for stat in stats_semaines %}
                  <tr>
                    <td>{{ stat.semaine }}</td>
                    <td>{{ stat.periode }}</td>
                    <td>{{ stat.entrees }}</td>
                    <td>{{ stat.candidats }}</td>
                    <td>{{ stat.taux_transformation|floatformat:1 }}%</td>
                    <td>{{ stat.objectif|floatformat:0 }}</td>
                    <td>{{ stat.pourcentage_objectif|floatformat:1 }}%</td>
                    <td>
                      <a href="{% url 'prepacomp:semaine_detail' pk=forloop.counter %}" class="btn btn-sm btn-info">
                        Détails
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                {% elif onglet_actif == 'mois' %}
                  {% for stat in stats_mois %}
                  <tr>
                    <td>{{ stat.mois }}</td>
                    <td>{{ stat.annee }}</td>
                    <td>{{ stat.entrees }}</td>
                    <td>{{ stat.candidats }}</td>
                    <td>{{ stat.taux_transformation|floatformat:1 }}%</td>
                    <td>{{ stat.objectif|floatformat:0 }}</td>
                    <td>{{ stat.pourcentage_objectif|floatformat:1 }}%</td>
                    <td>
                      <a href="{% url 'prepacomp:mois_detail' pk=forloop.counter %}" class="btn btn-sm btn-info">
                        Détails
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  {% for stat in stats_annees %}
                  <tr>
                    <td>{{ stat.annee }}</td>
                    <td>{{ stat.entrees }}</td>
                    <td>{{ stat.candidats }}</td>
                    <td>{{ stat.taux_transformation|floatformat:1 }}%</td>
                    <td>{{ stat.objectif }}</td>
                    <td>{{ stat.pourcentage_objectif|floatformat:1 }}%</td>
                    <td>
                      <a href="{% url 'prepacomp:annee_detail' annee=stat.annee %}" class="btn btn-sm btn-info">
                        Détails
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Boutons d'action -->
  <div class="row mb-4">
    <div class="col-md-12">
      <a href="{% url 'prepacomp:candidat_create' %}" class="btn btn-primary me-2">
        <i class="fas fa-user-plus"></i> Ajouter un candidat
      </a>
      <a href="{% url 'prepacomp:entree_create' %}" class="btn btn-success me-2">
        <i class="fas fa-door-open"></i> Enregistrer une entrée
      </a>
      {% if onglet_actif == 'annee' %}
      <a href="{% url 'prepacomp:objectif_update' annee=annee_courante %}" class="btn btn-warning">
        <i class="fas fa-edit"></i> Modifier l'objectif annuel
      </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Scripts pour les graphiques Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Variables pour les données des graphiques
    const labels = {{ chart_data.labels|safe }};
    const entrees = {{ chart_data.entrees|safe }};
    const candidats = {{ chart_data.candidats|safe }};
    const objectifs = {{ chart_data.objectifs|safe }};
    
    const labelsDepts = {{ chart_data.labels_depts|safe }};
    const valuesDepts = {{ chart_data.values_depts|safe }};
    
    // Graphique d'évolution
    const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
    new Chart(evolutionCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Entrées',
            data: entrees,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Candidats',
            data: candidats,
            backgroundColor: 'rgba(255, 206, 86, 0.5)',
            borderColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 1
          },
          {
            label: 'Objectif',
            data: objectifs,
            type: 'line',
            fill: false,
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Graphique par département
    const deptsCtx = document.getElementById('deptsChart').getContext('2d');
    new Chart(deptsCtx, {
      type: 'pie',
      data: {
        labels: labelsDepts,
        datasets: [{
          data: valuesDepts,
          backgroundColor: [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(199, 199, 199, 0.7)',
            'rgba(83, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true
      }
    });
    
    {% if onglet_actif == 'annee' %}
    // Graphique par mois pour l'année courante
    const labelsMois = {{ chart_data.labels_mois|safe }};
    const entreesMois = {{ chart_data.entrees_mois|safe }};
    const objectifsMois = {{ chart_data.objectifs_mois|safe }};
    
    const monthsCtx = document.getElementById('monthsChart').getContext('2d');
    new Chart(monthsCtx, {
      type: 'bar',
      data: {
        labels: labelsMois,
        datasets: [
          {
            label: 'Entrées',
            data: entreesMois,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Objectif',
            data: objectifsMois,
            type: 'line',
            fill: false,
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    {% endif %}
  });
</script>
{% endblock %}